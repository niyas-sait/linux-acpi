From 494afb71e0246ffe2d541d4fa746b5d4978df13b Mon Sep 17 00:00:00 2001
From: Niyas Sait <niyassait@gmail.com>
Date: Mon, 7 Aug 2023 08:27:55 +0100
Subject: [PATCH 4/5] some further hacks

---
 drivers/acpi/scan.c          |  3 ++-
 drivers/clk/clkdev.c         | 11 -----------
 drivers/devfreq/imx8m-ddrc.c |  4 ++++
 3 files changed, 6 insertions(+), 12 deletions(-)

diff --git a/drivers/acpi/scan.c b/drivers/acpi/scan.c
index ba1e8224d440..57481c527f60 100644
--- a/drivers/acpi/scan.c
+++ b/drivers/acpi/scan.c
@@ -1783,6 +1783,7 @@ static bool acpi_device_enumeration_by_parent(struct acpi_device *device)
 #include <linux/clkdev.h>
 #include <linux/clk-provider.h>
 
+void acpi_clk_register(struct acpi_device *adev, int index);
 
 void acpi_init_device_object(struct acpi_device *device, acpi_handle handle,
 			     int type)
@@ -1805,7 +1806,7 @@ void acpi_init_device_object(struct acpi_device *device, acpi_handle handle,
 	device_initialize(&device->dev);
 	dev_set_uevent_suppress(&device->dev, true);
 	acpi_init_coherency(device);
-	// acpi_clk_register(device, 0);
+	acpi_clk_register(device, 0);
 }
 
 static void acpi_scan_dep_init(struct acpi_device *adev)
diff --git a/drivers/clk/clkdev.c b/drivers/clk/clkdev.c
index 68da98ca6fcf..67f601a41023 100644
--- a/drivers/clk/clkdev.c
+++ b/drivers/clk/clkdev.c
@@ -18,12 +18,9 @@
 #include <linux/clkdev.h>
 #include <linux/clk-provider.h>
 #include <linux/of.h>
-#include <linux/acpi.h>
 
 #include "clk.h"
 
-struct clk_hw *acpi_clk_get_hw(struct acpi_device *adev, int index,const char *con_id);
-
 static LIST_HEAD(clocks);
 static DEFINE_MUTEX(clocks_mutex);
 
@@ -107,18 +104,10 @@ struct clk *clk_get(struct device *dev, const char *con_id)
 
 	if (dev && dev->of_node) {
 		hw = of_clk_get_hw(dev->of_node, 0, con_id);
-		printk("of hw %x \n", hw);
 		if (!IS_ERR(hw) || PTR_ERR(hw) == -EPROBE_DEFER)
 			return clk_hw_create_clk(dev, hw, dev_id, con_id);
-	} else if(has_acpi_companion(dev)){
-		// printk("acpi_clk_get_hw dev_id %s con_id %s \n", dev_id, con_id);
-		// hw = acpi_clk_get_hw(ACPI_COMPANION(dev), 0, con_id);
-		// printk("acpi hw %x \n", hw);
 	}
 
-	// printk("IS_ERR_OR_NULL(hw) %d  \n", IS_ERR_OR_NULL(hw));
-	// printk("PTR_ERR(hw) %d  \n", PTR_ERR(hw));
-	
 	return __clk_get_sys(dev, dev_id, con_id);
 }
 EXPORT_SYMBOL(clk_get);
diff --git a/drivers/devfreq/imx8m-ddrc.c b/drivers/devfreq/imx8m-ddrc.c
index 0fc22552f4cc..1891bbf809f4 100644
--- a/drivers/devfreq/imx8m-ddrc.c
+++ b/drivers/devfreq/imx8m-ddrc.c
@@ -384,6 +384,7 @@ static int imx8m_ddrc_probe(struct platform_device *pdev)
 	int ret;
 
 	struct clk *clk = devm_clk_get(&pdev->dev, NULL);
+	printk("imx8m-ddrc clk %x \n", clk);
 	printk("clk->getrate %d \n", clk_get_rate(clk));
 
 	priv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);
@@ -398,6 +399,9 @@ static int imx8m_ddrc_probe(struct platform_device *pdev)
 		return ret;
 	}
 
+	// get index 0 -> register "core"
+	// get index 1 -> register "pll"
+	
 	priv->dram_core = devm_clk_get_optional(dev, "core");
 	if (IS_ERR(priv->dram_core)) {
 		ret = PTR_ERR(priv->dram_core);
-- 
2.34.1

